# AGENTS.md – Repository Overview

This repository is a **modular dotfiles collection** built around **Nix flakes** and a small Bash helper for classic stow‑based installation.

---

## Core components

| Component | Description |
|-----------|-------------|
| `flake.nix` | Defines the Nix flake: inputs (`nixpkgs`, `home-manager`), a `mkConfiguration` helper, and three concrete NixOS configurations (`slate`, `halo`, `miami`). |
| `nixos/` | Contains all NixOS‑specific material.
| `nixos/machines/<host>/configuration.nix` | Host‑specific composition of modules (imports `base`, `desktop`, `backup`, etc.) and Home‑Manager configuration for the user. |
| `nixos/modules/` | Re‑usable NixOS modules:
- `base.nix` – generic system settings (users, networking, packages, Nix config).
- `backup.nix` – BorgBackup job definition using the `profile` arguments.
- `desktop.nix`, `laptop.nix`, `virtualisation.nix` – optional feature sets.
- `home-manager/` – per‑user Home‑Manager fragments (program settings, theme, etc.). |
| `nixos/overlays/` | Small package overlays that apply custom patches (e.g., `libinput` and `niri`). |
| `manage.sh` | Bash script that uses GNU stow to symlink the static config files (the *non‑Nix* part of the dotfiles). |
| `README.md` | Human‑readable usage notes (install via Nix flakes or `manage.sh`). |
| `scripts/` | Misc helper scripts (`backlight`, `volume`, `screenshot`, …). |
| `nvim/`, `kitty/`, `sway/`, `waybar/`, etc. | Raw configuration files for individual tools, kept in both `config/` (source) and `.config/` (stow target). |

---

## How it fits together

1. **Nix flake** – builds a complete NixOS system for each host. The `profile` attribute set (passed via `specialArgs`) supplies host‑specific values such as backup location, desktop/server role, and username.
2. **Modules** – consume `profile` to configure services (e.g., BorgBackup) and install packages.
3. **Home‑Manager** – enabled as a NixOS module, then configured per user (`${profile.user}`) using the fragments in `nixos/modules/home-manager/`.
4. **Stow helper** – `manage.sh` handles the classic dotfile symlinking for tools that aren’t managed by Nix (or for quick manual installs).

---

## Adding a new host

1. Create `nixos/machines/<newhost>/` with a `hardware-configuration.nix` generated by `nixos-generate-config`.
2. Copy an existing `configuration.nix` and adjust `networking.hostName`, backup settings, and `desktop/server` flags.
3. Add an entry to `flake.nix` under `nixosConfigurations` using `mkConfiguration { host = "<newhost>"; … }`.
4. Re‑build with `nixos-rebuild switch --flake .#<newhost>`.

---

## Quick reference commands

```bash
# Update inputs (nixpkgs, home‑manager)
nix flake lock --update-input nixpkgs
nix flake lock --update-input home-manager

# Build a host configuration (dry‑run)
nix build .#nixosConfigurations.slate.config.system.build.toplevel

# Deploy to a machine (run on the target)
sudo nixos-rebuild switch --flake /path/to/dotfiles#slate
```

---

*The repo is intentionally modular: system‑wide NixOS settings, per‑user Home‑Manager config, and classic stow‑based dotfiles live side‑by‑side, enabling you to manage the whole workstation from a single flake.*
