#!/usr/bin/env bash
# Fetch lyrics on lrclib.net

set -euo pipefail

# Artist, Album, Title, Duration
artist=
album=
title=

args=()

function help() {
  cat <<EOF
$0 args

With args in
-h | --help
-a | --artist
-A | --album
-t | --title
-o | --auto
-v | --verbose
EOF
}

while [[ $# != 0 ]]; do
  case "$1" in
  -h|--help)
    help
    exit 0
    ;;

  -a|--artist)
    shift
    artist="$1"
    ;;

  -A|--album)
    shift
    album="$1"
    ;;

  -t|--title)
    shift
    title="$1"
    ;;

  -v|--verbose)
    set -x
    ;;

  -o|--auto)
    artist="$(playerctl metadata --format "{{artist}}")"
    album="$(playerctl metadata --format "{{album}}")"
    title="$(playerctl metadata --format "{{title}}")"
    ;;

  *)
    help >&2
    exit 1
    ;;
  esac

  shift
done

# Store args
if [[ -n $artist ]]; then
  args+=("--data-urlencode")
  args+=("artist_name='$artist'")
fi
if [[ -n $album ]]; then
    args+=("--data-urlencode")
    args+=("album_name='$album'")
fi
if [[ -n $title ]]; then
    args+=("--data-urlencode")
    args+=("track_name='$title'")
fi

# Send request 
# Damn this is ugly
eval curl -s --get https://lrclib.net/api/get "${args[*]}" \
    | jq .plainLyrics --monochrome-output \
      | xargs echo -e \
        | bat --file-name "$artist - $title"
